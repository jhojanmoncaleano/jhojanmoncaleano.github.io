self.scriptsLoaded = self.scriptsLoaded || {}; self.scriptProcessStart = self.scriptProcessStart || {}; self.scriptProcessStart['owa.339.js'] = (new Date()).getTime();(window.$wj=window.$wj||[]).push([[339],{11958:function(t,e,n){"use strict";var a=n(2867),i=n(267);e.a=async t=>{const e={method:"GET"};e.headers=new Headers,e.headers.set(a.c,a.d),e.headers.set("Content-Type","application/json;charset=utf-8");const n=await fetch(t,e);if(!Object(i.a)(n.status))throw new Error(`The data package cannot be retrieved. StatusCode: ${n.status}`);return await n.text()}},11961:function(t,e,n){"use strict";var a=n(2823),i=n(3459),o=n(4616),r=n(7e3),c=n(3666),s=n(1932),m=n(3609),d=n(4065),h=n(1738),u=n(699),l=n(2065);e.a=Object(u.action)("updateSmimeAttachment")((function(t,e,n,u,f){Object(r.a)(n,f)&&Object(d.a)(t.attachmentId);const I=Object(l.a)(n);if(n.AttachmentId=e,n.Name=u.Name||n.Name,n.Size=u.Size||n.Size,n.ContentType=u.ContentType||n.ContentType,n.__type=u.__type||n.__type,2===I?n.MimeContent=u.MimeContent:0===I&&(n.Content=u.Content),n.IsInline&&(n.ContentId=u.ContentId||n.ContentId),Object(m.a)([{attachmentId:e,attachment:n}],!1),t.attachmentId=e,Object(c.a)(t))Object(i.a)(t,1);else{const n=Object(h.a)(e);Object(s.h)(t,!1),Object(o.a)(t,0),Object(a.a)(t,n,!1,[])}}))},11962:function(t,e,n){"use strict";function a(t){return Object.assign({__type:"AttachmentId:#Exchange"},t)}n.d(e,"a",(function(){return a}))},15912:function(t){t.exports=JSON.parse('{"a":"ipb","b":"jpb"}')},1897:function(t,e,n){"use strict";n.d(e,"h",(function(){return a})),n.d(e,"j",(function(){return i})),n.d(e,"s",(function(){return o})),n.d(e,"q",(function(){return r})),n.d(e,"a",(function(){return c})),n.d(e,"n",(function(){return s})),n.d(e,"b",(function(){return m})),n.d(e,"c",(function(){return d})),n.d(e,"f",(function(){return h})),n.d(e,"g",(function(){return u})),n.d(e,"e",(function(){return l})),n.d(e,"k",(function(){return f})),n.d(e,"d",(function(){return I})),n.d(e,"i",(function(){return p})),n.d(e,"p",(function(){return b})),n.d(e,"m",(function(){return w})),n.d(e,"r",(function(){return O})),n.d(e,"o",(function(){return g})),n.d(e,"l",(function(){return S}));const a="multipart/signed",i="application/pkcs7-mime",o="application/x-pkcs7-mime",r=".p7m",c="CLSID:56023A83-B4FC-413B-9285-6BB1DAD977A2",s="CLASSID",m="4",d="0800",h=57,u=78,l="IPM.Note.SMIME.MultipartSigned",f="smime-",I="image",p="OwaToSmime",b="SmimeToOwa",w="en-US",O=["Culture","CodePage","AttachmentSizeLimit","UseKeyIdentifier","AllowUserChoiceOfSigningCertificate","IncludeCertificateChainWithoutRootCertificate","IncludeCertificateChainAndRootCertificate","EncryptTemporaryBuffers","SignedEmailCertificateInclusion","IncludeSmimeCapabilitiesInMessage","CopyRecipientHeaders","OnlyUseSmartCard","EncryptionAlgorithms","SigningAlgorithms","AlwaysEncrypt","AlwaysSign","TripleWrapSignedEncryptedMail","BccEncryptedEmailForking"],g="https://microsoftedge.microsoft.com/addons/detail/gamjhjfeblghkihfjdpmbpajhlpmobbp",S="chrome-extension://maafgiompdekodanheihhgilkjchcakm/Options.html"},2023:function(t,e,n){"use strict";n.d(e,"a",(function(){return a}));const a="IPM.Note.SMIME"},2867:function(t,e,n){"use strict";n.d(e,"c",(function(){return a})),n.d(e,"d",(function(){return i})),n.d(e,"e",(function(){return o})),n.d(e,"b",(function(){return r})),n.d(e,"a",(function(){return c}));const a="X-OWA-SmimeInstalled",i="1",o="SmimeWithoutActiveX",r="message/rfc822",c="ErrorSmimeSendCancelled"},4599:function(t){t.exports=JSON.parse('{"a":"kpb"}')},4947:function(t,e,n){"use strict";n.d(e,"b",(function(){return a})),n.d(e,"c",(function(){return i})),n.d(e,"a",(function(){return o}));const a="application/octet-stream",i=1024,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},5579:function(t,e,n){"use strict";class a extends Error{constructor(t,e,n){super(t),this.errorCode=e,this.errorContext=n}}e.a=a},7e3:function(t,e,n){"use strict";function a(t,e){var n;const a=null===(n=null==t?void 0:t.AttachmentId)||void 0===n?void 0:n.RootItemId;return a&&e&&a===e.Id}n.d(e,"a",(function(){return a}))},7001:function(t,e,n){"use strict";n.d(e,"a",(function(){return i}));var a=n(4947);function i(t){if(!t)return t;const e=t.toLowerCase().charCodeAt(0);if(e>=97&&e<=122&&-1===t.indexOf("#")&&-1===t.indexOf("-"))try{return atob(t)}catch(t){}let n="",i=0;const o=()=>{const e=t.charAt(i++);switch(e){case"\r":case"\n":return o();default:return e}};for(;i<t.length;){const t=a.a.indexOf(o()),e=a.a.indexOf(o()),i=a.a.indexOf(o()),r=a.a.indexOf(o()),c=t<<2|e>>4,s=(15&e)<<4|i>>2,m=(3&i)<<6|r;n+=String.fromCharCode(c),64!=i&&(n+=String.fromCharCode(s)),64!=r&&(n+=String.fromCharCode(m))}return n}},9029:function(t,e,n){"use strict";var a=n(7920),i=n(5),o=n(1866),r=n(3960),c=n(40);var s=t=>{if(!t)return t;if(0===t.indexOf("data:")){const e=";base64,",n=t.indexOf(e);return t.substr(n+e.length)}return t},m=n(61),d=n(11961),h=n(7e3),u=n(1738),l=n(3015),f=n(7001),I=n(4599),p=n(11962),b=n(32),w=n(910);var O=n(2653),g=n(11958),S=n(5579),j=n(209),A=n(2532);var C=async(t,e)=>{const n=new m.b("FetchAttachmentContent",{isCore:!0}),a=Object(A.a)(Object.assign({mailboxInfo:Object(j.d)()},t),0);try{const t=await Object(g.a)(`${a}${e?"&asDataUri=true":""}`);return n.end(),t}catch(t){throw c.d(`SmimeTraceError: FetchAttachmentContent failed. URL: ${a}`),n.endWithError("ServerError",t),new S.a(t.message,11)}},D=n(15912),y=n(1975),E=n(2065),M=n(1829),x=n(1751);const v="S/MIME: Unsupported reference attachment",F="S/MIME: Unsupported attachment type";class N{constructor(t,e,n){this.attachmentWellViewState=t,this.parentItemId=e,this.infoBar=n,this.downloadQueue=[],this.downloadFailures=[],this.deleteQueue=[],this.onFinishPromise=new Promise((t,e)=>{this.onFinish=function(e){t(e)}})}enqueueSmimeAttachmentDownload(t,e=null){t.map(t=>{const n={attachmentState:t,attachment:Object(u.a)(t.attachmentId),onAttachmentDownloaded:e};this.downloadQueue.push(n)}),this.startProcessIfNotStarted()}deleteSmimeAttachment(t,e){const n=1===t.attachmentType,a=n?0===t.status:0===t.ongoingAction;n||Object(y.A)(t,3,6),a&&this.currentDownloadItem&&this.currentDownloadItem.attachmentState.attachmentId!==t.attachmentId&&(c.h.info("Attachment: Removing attachment: TempId= "+t.attachmentId+" from S/MIME download queue"),this.removeRelatedItemFromDownloadQueue(t,this.downloadQueue)),this.deleteQueue.push({attachmentState:t,onAttachmentDeleted:e}),this.startProcessIfNotStarted()}startProcessIfNotStarted(){this.isInProgress||(this.datapoint=new m.b("SmimeAttachmentQueueManager"),this.isInProgress=!0,this.processNextAttachment())}async processNextAttachment(){var t,e,n;if(0!=this.deleteQueue.length){const{attachmentState:t,onAttachmentDeleted:e}=this.deleteQueue.shift(),n=Object(u.a)(t.attachmentId);Object(l.a)(this.attachmentWellViewState,t),null==e||e(this.parentItemId,n.model.AttachmentId,n.model),this.processNextAttachment()}else if(0!==this.downloadQueue.length){this.currentDownloadItem=this.downloadQueue.shift();const{attachmentState:a,attachment:i,onAttachmentDownloaded:o}=this.currentDownloadItem,r=Object(E.a)(i.model),u=i.model;let l;try{const c=this.getAttachmentId(i.model,this.parentItemId);if(l=Object.assign({},u),2===r){const a=u;if(null===(t=a.Item)||void 0===t?void 0:t.MimeContent)l.MimeContent=Object(f.a)(a.Item.MimeContent.Value);else if(!u.MimeContent){const t=(null==c?void 0:c.Id)?await C(c):await(e={itemId:this.getItemId(i.model)},void 0===e.itemId||e.itemId.__type||(e.itemId=Object(w.a)(e.itemId)),Object(b.a)("GetMime",e,n));l.__type=x.b,l.MimeContent=t,Object(m.o)("SmimeAttachmentDownloadDatapoint",{isMailDownload:!0},{isCore:!0})}}else{if(0!==r)throw 1===r?new Error(v):new Error(F);if(u.Content)l=Object.assign({},u);else{const t=await C(c,!0);l.__type=x.a,l.Content=s(t),Object(m.o)("SmimeAttachmentDownloadDatapoint",{isFileDownload:!0},{isCore:!0})}}let I=u.AttachmentId;Object(M.c)(u)&&Object(h.a)(u,this.parentItemId)||(I=Object.assign(Object.assign({},Object(p.a)({Id:Object(O.e)()})),{mailboxInfo:this.parentItemId.mailboxInfo})),null==o||o(i.model),Object(d.a)(a,I,u,l,this.parentItemId)}catch(t){t.message!==v&&c.d("SmimeTraceError: "+t.message);const{IsInline:e}=this.currentDownloadItem.attachment.model,{attachmentClass:n,type:a}=this.currentDownloadItem.attachment;Object(m.o)("SmimeAttachmentDownloadDatapoint",{attachmentClass:n,type:a,IsInline:e,isError:!0,message:t.message},{isCore:!0});const i={item:this.currentDownloadItem,reason:t.message===v?1:0};this.downloadFailures.push(i)}finally{this.processNextAttachment()}}else this.finishProcess()}finishProcess(){const t=this.currentDownloadItem&&this.currentDownloadItem.attachmentState?this.currentDownloadItem.attachmentState.attachmentId:null;c.h.info("Attachment: SmimeAttachmentQueueManager: finishProcess"),this.isInProgress=!1,this.currentDownloadItem=null,this.onFinish(t),this.datapoint.end(),this.datapoint=null,this.downloadFailures.length&&this.removeFromAttachmentWellAndShowError(this.downloadFailures),this.downloadFailures=[]}removeRelatedItemFromDownloadQueue(t,e){for(let n=0;n<e.length;n++){e[n].attachmentState.attachmentId===t.attachmentId&&e.splice(n,1)}}removeFromAttachmentWellAndShowError(t){const e=[],n=[];t.map(t=>{const a=t.item.attachment&&t.item.attachment.model.Name;1===t.reason?e.push(a):0===t.reason&&n.push(a),Object(l.a)(this.attachmentWellViewState,t.item.attachmentState)}),e.length>0&&Object(o.a)(this.infoBar,"ErrorSmimeHasCloudOrUriAttachments",[Object(i.c)(Object(i.b)(I.a),e.join(", "))]),n.length>3?Object(o.a)(this.infoBar,"ErrorAttachmentDownloadFailedMultipleFiles",[Object(i.c)(Object(i.b)(D.b),n.length)]):n.length>0&&Object(o.a)(this.infoBar,"ErrorAttachmentDownloadFailed",[Object(i.c)(Object(i.b)(D.a),n.join(", "))])}getAttachmentId(t,e){const n=t,a=n.AttachmentIdToAttach&&Object(p.a)({Id:n.AttachmentIdToAttach});let i;switch(t.__type){case x.b:case x.c:i=a;break;default:i=a||t.AttachmentId}return Object.assign(Object.assign({},i),{mailboxInfo:e.mailboxInfo})}getItemId(t){const e=t;return e.Item?e.Item.ItemId:e.ItemId}}n.d(e,"a",(function(){return P})),n.d(e,"b",(function(){return Q}));const T={};function P(t,e,n,c,s){if(!e)return Object(r.a)(n),Object(o.a)(n,"WarningFilesCanNotBeAttachedGenericError",[Object(i.b)(a.a)]),[];return _(t,e,n).enqueueSmimeAttachmentDownload(c,s)}function Q(t,e,n,a,i){_(t,n,a).deleteSmimeAttachment(e,i)}function _(t,e,n){let a=T[e.Id];return a||(c.h.info("Creating SmimeAttachmentQueueManager"),a=function(t,e,n){return new N(t,e,n)}(t,e,n),T[e.Id]=a,a.onFinishPromise.then(()=>{c.h.info("Deleting SmimeAttachmentQueueManager"),delete T[e.Id]})),a}}}]);
//# sourceMappingURL=owa.339.js.map
self.scriptsLoaded['owa.339.js'] = 1; self.scriptProcessEnd = self.scriptProcessEnd || {}; self.scriptProcessEnd['owa.339.js'] = (new Date()).getTime();